<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <title>OAuth2 Callback</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.js" integrity="sha512-RjvSEaeDqPCfUVQ9kna2/2OqHz/7F04IOl1/66LmQjB/lOeAzwq7LrbTzDbz5cJzlPNJ5qteNtHR56XaJSTNWw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  </head>

  <body>
    <h1>OAuth2 Callback</h1>
    <div>
      STATE = <code id="txtState"></code>
    </div>
    <code id="atoken"></code>
  </body>

  <script>
    async function decode(rawBody) {
      try {
        const response = await axios.post('https://dauden.cloud/node-token-updrive/decode', rawBody);
        console.log(response.data); // handle response data here
        return response.data;
      } catch (error) {
        console.error(error); // handle error here
        return null;
      }
    }
    $(document).ready(async function () {
      console.log("ready!");
      

      // Get the authorization code from the query string parameters
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      $('#txtState').text(state);
      let credentials = await decode(state)

      // Send a request to exchange the authorization code for an access token
      const xhr = new XMLHttpRequest();
      xhr.open('POST', credentials.token_uri);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onload = function () {
        if (xhr.status === 200) {
          // Handle the response from the server
          const response = JSON.parse(xhr.responseText);
          const accessToken = response.access_token;
          const expiresIn = response.expires_in;
          const tokenType = response.token_type;
          // Do something with the access token, such as storing it in a cookie or session
          $('#atoken').text(accessToken)
        } else {
          // Handle the error from the server
          console.error('Failed to exchange authorization code for access token');
        }
      };
      xhr.send(`code=${code}&client_id=${credentials.client_id}&client_secret=${credentials.client_secret}&redirect_uri=${credentials.redirect_uris[0]}&grant_type=authorization_code`);
    });


  </script>

</html>