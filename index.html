<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <title>OAuth2 Callback</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.js" integrity="sha512-RjvSEaeDqPCfUVQ9kna2/2OqHz/7F04IOl1/66LmQjB/lOeAzwq7LrbTzDbz5cJzlPNJ5qteNtHR56XaJSTNWw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  </head>

  <body>
    <h1>OAuth2 Callback</h1>
    <h2>Credentials</h2>
    <pre>
      <div id="txtState"></div>
    </pre>

    <br />
    <h2>TOKEN</h2>
    <pre>
      <code id="atoken"></code>
    </pre>

  </body>

  <script>
    async function decode(rawBody) {
      try {
        const response = await axios.post('https://dauden.cloud/node-token-updrive/decode', rawBody);
        console.log(response.data); // handle response data here
        return response.data;
      } catch (error) {
        console.error(error); // handle error here
        return null;
      }
    }
    $(document).ready(async function () {
      console.log("ready!");


      // Get the authorization code from the query string parameters
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');

      let credentials = await decode(state)

      $('#txtState').text(JSON.stringify(credentials));

      if (credentials.web) {
        credentials = credentials.web
      }

      const requestBody = new URLSearchParams();
      requestBody.append('code', code);
      requestBody.append('client_id', credentials.client_id);
      requestBody.append('client_secret', credentials.client_secret);
      requestBody.append('redirect_uri', credentials.redirect_uris[0]);
      requestBody.append('grant_type', 'authorization_code');

      const config = {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      };

      const response = await axios.post(credentials.token_uri, requestBody.toString(), config);

      $('#atoken').text(JSON.stringify(response.data))

      // xhr.send(`code=${code}&client_id=${credentials.client_id}&client_secret=${credentials.client_secret}&redirect_uri=${credentials.redirect_uris[0]}&grant_type=authorization_code`);
    });


  </script>

</html>